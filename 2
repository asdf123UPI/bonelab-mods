Add-Type -AssemblyName System.Speech
Add-Type -AssemblyName Microsoft.VisualBasic

# Hide Console
Add-Type -Name Win -Namespace H -MemberDefinition '
  [DllImport("kernel32.dll")]public static extern IntPtr GetConsoleWindow();
  [DllImport("user32.dll")]public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);'
$consolePtr = [H.Win]::GetConsoleWindow()
[H.Win]::ShowWindow($consolePtr, 0)

# Prepare paths
$TempPath = "$env:TEMP\prnkcam"
$FfmpegPath = "$TempPath\ffmpeg.exe"
$ImagePath = "$TempPath\captured.jpg"
$Desktop = [Environment]::GetFolderPath("Desktop")
$NoFile = "$Desktop\no.txt"

# Ensure temp dir
New-Item -ItemType Directory -Path $TempPath -Force | Out-Null

# Download ffmpeg if needed
if (!(Test-Path $FfmpegPath)) {
    Invoke-WebRequest "https://github.com/ffbinaries/ffbinaries-prebuilt/releases/download/v4.4.1/ffmpeg-win64.zip" -OutFile "$TempPath\ffmpeg.zip" -UseBasicParsing
    Expand-Archive "$TempPath\ffmpeg.zip" -DestinationPath $TempPath -Force
    $ffFound = Get-ChildItem "$TempPath" -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
    if ($ffFound) { Move-Item $ffFound.FullName $FfmpegPath -Force }
    Remove-Item "$TempPath\ffmpeg.zip" -Force
}

# Detect camera name
$camListRaw = & $FfmpegPath -list_devices true -f dshow -i dummy 2>&1
$camDevice = ($camListRaw | Select-String "video devices" -Context 0,10 | Select-String '\"(.*)\"').Matches.Groups[1].Value

if (-not $camDevice) {
    Set-Content -Path $NoFile -Value "No camera detected." -Force
    exit
}

# Attempt capture
& $FfmpegPath -f dshow -i "video=$camDevice" -vframes 1 "$ImagePath" -y -loglevel quiet
if (!(Test-Path $ImagePath)) {
    Set-Content -Path $NoFile -Value "Failed to capture image from camera." -Force
    exit
}

# Set as wallpaper
Add-Type @"
using System.Runtime.InteropServices;
public class Wallpaper {
  [DllImport("user32.dll", SetLastError=true)]
  public static extern bool SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
}
"@
[Wallpaper]::SystemParametersInfo(20, 0, $ImagePath, 3)

# Speak fun message
$speak = New-Object System.Speech.Synthesis.SpeechSynthesizer
$speak.Rate = -1
$speak.SelectVoice("Microsoft Zira Desktop")
$speak.Speak("Smile. Youâ€™ve been captured.")
Start-Sleep -Milliseconds 800
$speak.Speak("You are now a permanent background.")

# Final popup
[Microsoft.VisualBasic.Interaction]::MsgBox("This was a prank. Nothing harmful was done. Check your wallpaper ðŸ˜ˆ", "OKOnly,Info", "PRANK COMPLETE")
exit
