# PowerShell 5.1 compatible prank-script: webcam snapshot > set as wallpaper > TTS + cleanup
$ErrorActionPreference = "SilentlyContinue"
$temp = "$env:TEMP\WebPrank"
$log = "$temp\log.txt"
New-Item -ItemType Directory -Force -Path $temp | Out-Null
function Write-Log {
    param ([string]$msg)
    Add-Content -Path $log -Value "$(Get-Date -Format 'HH:mm:ss') :: $msg"
}
Write-Log "–°–∫—Ä–∏–ø—Ç —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª."

# === –°–∫–∞—á–∏–≤–∞–µ–º –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º ffmpeg –±–µ–∑ ZIP UI ===
$ffmpegPage = Invoke-WebRequest "https://www.gyan.dev/ffmpeg/builds/" -UseBasicParsing
$zipRelative = ($ffmpegPage.Links | Where-Object href -Match "ffmpeg-release.*essential.*\.zip$")[0].href
$zipUrl = "https://www.gyan.dev$zipRelative"
$zipPath = "$temp\ffmpeg.zip"
Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
Write-Log "FFmpeg ZIP —Å–∫–∞—á–∞–Ω."

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ
Add-Type -AssemblyName System.IO.Compression.FileSystem
[System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, "$temp\ffmpeg")
$ffmpegExe = Get-ChildItem -Path "$temp\ffmpeg" -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
if (-not $ffmpegExe) {
    Write-Log "ffmpeg.exe –Ω–µ –Ω–∞–π–¥–µ–Ω."
    [IO.File]::WriteAllText("$env:USERPROFILE\Desktop\no.txt", "–û—à–∏–±–∫–∞: ffmpeg –Ω–µ –Ω–∞–π–¥–µ–Ω.")
    exit
}
Write-Log "FFmpeg –Ω–∞–π–¥–µ–Ω: $($ffmpegExe.FullName)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±-–∫–∞–º–µ—Ä—ã
$testCmd = "$($ffmpegExe.FullName) -f dshow -list_devices true -i dummy"
$result = & cmd /c $testCmd 2>&1
if ($result -notmatch "video devices") {
    Write-Log "–í–µ–±–∫–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
    [IO.File]::WriteAllText("$env:USERPROFILE\Desktop\no.txt", "–ö–∞–º–µ—Ä–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞.")
    exit
}
Write-Log "–ö–∞–º–µ—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞."

# –°–Ω–∏–º–æ–∫
$snapshotPath = "$temp\snap.jpg"
& cmd /c "$($ffmpegExe.FullName) -f dshow -i video=""video=*" -frames:v 1 ""$snapshotPath"" -y"
if (!(Test-Path $snapshotPath)) {
    Write-Log "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫."
    exit
}
Write-Log "–°–Ω–∏–º–æ–∫ —Å–¥–µ–ª–∞–Ω: $snapshotPath"

# === –û–ë–û–ò –ë–ï–ó using ===
function Set-Wallpaper($path) {
    $signature = @"
    [DllImport("user32.dll", CharSet = CharSet.Auto)]
    public static extern int SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
"@
    Add-Type -MemberDefinition $signature -Name "Win32" -Namespace "Wallpaper" -PassThru | Out-Null
    [Wallpaper.Win32]::SystemParametersInfo(20, 0, $path, 3) | Out-Null
}
Set-Wallpaper -path $snapshotPath
Write-Log "–û–±–æ–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."

# === TTS ===
Add-Type -AssemblyName System.Speech
$sp = New-Object System.Speech.Synthesis.SpeechSynthesizer
$sp.Speak("–¢–µ–ø–µ—Ä—å —Ç—ã –Ω–∞ —Ñ–æ–Ω–µ.")

# === –î–∏–∞–ª–æ–≥ ===
Add-Type -AssemblyName PresentationFramework
[System.Windows.MessageBox]::Show("–ü—Ä–∞–Ω–∫ —É–¥–∞–ª—Å—è", "üëª –•–∞-—Ö–∞!", 'OK', 'Information')

# === –û—á–∏—Å—Ç–∫–∞ ===
Remove-Item -Path $temp -Recurse -Force
Write-Log "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –£—Å–ø–µ—Ö."
