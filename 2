#requires -version 5.1
<#
.SYNOPSIS
  –ü—Ä–∞–Ω–∫: –¥–µ–ª–∞–µ—Ç —Ñ–æ—Ç–æ —Å –≤–µ–±-–∫–∞–º–µ—Ä—ã, —Å—Ç–∞–≤–∏—Ç –µ–≥–æ –Ω–∞ —Ñ–æ–Ω —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞ + TTS

.DESCRIPTION  
  PowerShell —Å–∫—Ä–∏–ø—Ç –±–µ–∑ GUI, –±–µ–∑ –∞—Ä—Ö–∏–≤–æ–≤, –±–µ–∑ –∞–¥–º–∏–Ω–∞.
  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç ffmpeg (—Å–∫–∞—á–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ .exe), –ø—Ä–æ–≤–µ—Ä—è–µ—Ç SHA256, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–Ω–∏–º–æ–∫, –¥–µ–ª–∞–µ—Ç —Ñ–æ–Ω–æ–º.

.AUTHOR
  DEFCON-grade Scriptlord üõ†Ô∏è ‚ò†Ô∏è
#>

# –û—Ç–∫–ª—é—á–∞–µ–º –æ—à–∏–±–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
$ErrorActionPreference = "SilentlyContinue"

# ==== –°–ï–ö–¶–ò–Ø 1 ‚Äî –ü–û–î–ì–û–¢–û–í–ö–ê –ü–ê–ü–û–ö, –õ–û–ì–û–í ==== #
$temp = "$env:TEMP\WebPrank"
$log = "$temp\log.txt"
New-Item -ItemType Directory -Force -Path $temp | Out-Null

function Write-Log {
    param([string]$msg)
    Add-Content -Path $log -Value "$(Get-Date -Format 'HH:mm:ss') :: $msg"
}

Write-Log "–°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω."

# ==== –°–ï–ö–¶–ò–Ø 2 ‚Äî –°–ö–ê–ß–ò–í–ê–ï–ú FFMPEG-EXE ==== #
$ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
$ffmpegDownloadPage = Invoke-WebRequest "https://www.gyan.dev/ffmpeg/builds/" -UseBasicParsing

# ‚ö†Ô∏è –£ Gyan.dev –Ω–µ—Ç –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–∏ –Ω–∞ .exe ‚Äî —Ç–æ–ª—å–∫–æ ZIP
# –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–ø–æ—Å–æ–± –≤—ã–≥—Ä—É–∑–∫–∏ .exe –Ω–∞–ø—Ä—è–º—É—é

Write-Log "–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ .exe –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–µ–º workaround —Å Gyan.dev + —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ö–∏–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ, –ø–æ—Ç–æ–º –∏–∑–≤–ª–µ–∫–∞–µ–º –Ω—É–∂–Ω—ã–π .exe –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
$ffmpegZipUrl = ($ffmpegDownloadPage.Links | Where-Object { $_.href -match "ffmpeg-release.*essential.*\.zip$" })[0].href
$fullZipUrl = "https://www.gyan.dev$ffmpegZipUrl"
$zipPath = "$temp\ffmpeg.zip"
Invoke-WebRequest -Uri $fullZipUrl -OutFile $zipPath
Write-Log "–ê—Ä—Ö–∏–≤ ffmpeg —Å–∫–∞—á–∞–Ω: $zipPath"

# –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ ffmpeg.exe
Add-Type -AssemblyName System.IO.Compression.FileSystem
[System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, "$temp\ffmpeg")

$ffmpegExe = Get-ChildItem -Path "$temp\ffmpeg\" -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
if (-not $ffmpegExe) {
    Write-Log "ffmpeg.exe –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞—Ä—Ö–∏–≤–µ"
    [IO.File]::WriteAllText("$env:USERPROFILE\Desktop\no.txt", "–û—à–∏–±–∫–∞: ffmpeg –Ω–µ –Ω–∞–π–¥–µ–Ω.")
    exit
}
Write-Log "ffmpeg.exe –Ω–∞–π–¥–µ–Ω: $($ffmpegExe.FullName)"

# ==== –°–ï–ö–¶–ò–Ø 3 ‚Äî –ü–†–û–í–ï–†–ö–ê SHA256 ==== #
$expectedHash = "A_FAKE_PLACEHOLDER_HASH_256" # ‚ö† –í—Å—Ç–∞–≤—å —Ä–µ–∞–ª—å–Ω—ã–π SHA256 release
$actualHash = Get-FileHash -Path $ffmpegExe.FullName -Algorithm SHA256 | Select-Object -ExpandProperty Hash
Write-Log "SHA256 ffmpeg: $actualHash"

if ($expectedHash -ne "A_FAKE_PLACEHOLDER_HASH_256") {
    if ($actualHash -ne $expectedHash) {
        Write-Log "–û—à–∏–±–∫–∞: –•–µ—à –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç!"
        [IO.File]::WriteAllText("$env:USERPROFILE\Desktop\no.txt", "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: ffmpeg –Ω–∞—Ä—É—à–µ–Ω.")
        exit
    }
}

# ==== –°–ï–ö–¶–ò–Ø 4 ‚Äî –ü–†–û–í–ï–†–ö–ê –í–ï–ë-–ö–ê–ú–ï–†–´ ==== #
Write-Log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±-–∫–∞–º–µ—Ä—ã —á–µ—Ä–µ–∑ ffmpeg..."
$testCmd = "$($ffmpegExe.FullName) -f dshow -list_devices true -i dummy" 
$camOutput = & cmd /c $testCmd 2>&1

if ($camOutput -notmatch "video devices") {
    Write-Log "–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
    [IO.File]::WriteAllText("$env:USERPROFILE\Desktop\no.txt", "–ö–∞–º–µ—Ä–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞.")
    exit
}

# ==== –°–ï–ö–¶–ò–Ø 5 ‚Äî –§–û–¢–û –°–ï–°–°–ò–Ø ==== #
$outputImage = "$temp\face.jpg"
& cmd /c "$($ffmpegExe.FullName) -f dshow -i video=""video=*" -frames:v 1 $outputImage"

if (-not (Test-Path $outputImage)) {
    Write-Log "–§–æ—Ç–æ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ."
    exit
}

Write-Log "–§–æ—Ç–æ —Å–æ–∑–¥–∞–Ω–æ: $outputImage"

# ==== –°–ï–ö–¶–ò–Ø 6 ‚Äî –û–ë–û–ò ==== #
function Set-Wallpaper($file) {
    Add-Type @"
    using System.Runtime.InteropServices;
    public class Wallpaper {
        [DllImport("user32.dll", SetLastError=true)]
        public static extern bool SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
    }
"@
    [Wallpaper]::SystemParametersInfo(20, 0, $file, 3) | Out-Null
}

Set-Wallpaper -file $outputImage
Write-Log "–§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ–±–æ–µ–≤."

# ==== –°–ï–ö–¶–ò–Ø 7 ‚Äî TTS –ü–û–õ–Å–¢ ==== #
Add-Type -AssemblyName System.Speech
$tts = New-Object System.Speech.Synthesis.SpeechSynthesizer
$tts.SelectVoiceByHints([System.Speech.Synthesis.VoiceGender]::Male)
$tts.Speak("–¢–µ–ø–µ—Ä—å —Ç—ã –Ω–∞ —Ñ–æ–Ω–µ.")

# ==== –°–ï–ö–¶–ò–Ø 8 ‚Äî –î–∏–∞–ª–æ–≥ ==== #
Add-Type -AssemblyName PresentationFramework
[System.Windows.MessageBox]::Show("–ü—Ä–∞–Ω–∫ —É–¥–∞–ª—Å—è", "üëª –•–∞-—Ö–∞!", 'OK', 'Information')

# ==== –°–ï–ö–¶–ò–Ø 9 ‚Äî –£–ë–û–†–ö–ê ==== #
Remove-Item -Path $temp -Recurse -Force
Write-Log "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

# ==== –°–ï–ö–¶–ò–Ø 10 ‚Äî –§–ò–ù–ê–õ ====
Write-Log "–°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ." 
exit
